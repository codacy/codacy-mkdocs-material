<!-- User feedback
     Must be enabled on mkdocs.yml:
     
     extra:
       user_feedback: "true"
-->
{% if config.extra.user_feedback == "true" and (not page.is_homepage and page.content) %}
  <style>
    #user-feedback {
      margin-top: 3em;
      padding: 1em;
      background-color: var(--codacy-neutral-50);
    }

    #feedback {
      margin-top: unset;
    }

    .user-feedback-answer,
    .user-feedback-send {
      background-color: var(--md-accent-fg-color--transparent);
      border-radius: .3em;
      color: var(--codacy-neutral-600);
      display: inline-block;
      font: inherit;
      font-size: .9em;
      padding: .2em .5em .2em 0;
      cursor: pointer;
      width: 6em;
    }

    .user-feedback-answer:hover {
      background-color: var(--codacy-neutral-300);
    }

    .user-feedback-answer .svg-icon {
      display: inline-block;
      margin-right: .5em;
      vertical-align: top;
      width: 1.3em;
    }

    .user-feedback-answer:disabled,
    .user-feedback-send:disabled {
      background-color: var(--md-default-fg-color--lightest);
    }

    .user-feedback-send {
      float: left;
    }

    .user-feedback-answer--no {
      margin-left: 1em;
    }

    .user-feedback-response {
      display: none;
    }

    .user-feedback-response--visible {
      display: block;
    }

    .user-feedback-response textarea {
      border: 1px solid var(--md-accent-fg-color--transparent);
      border-radius: 0.3em;
      padding: 0.75rem 0.5rem 0.75rem 0.75rem;
      line-height: 1.10rem;
      width: 100%;
      max-width: 550px;
    }

    .feedback-prompt--invisible {
      display: none;
    }

    .user-feedback-thanks {
      display: none;
    }

    .user-feedback-thanks--visible {
      display: block;
    }

    .character-count {
      font-size: 0.8em;
      float: right;
    }
  </style>  
  <div id="user-feedback">
    <h3 id="feedback">Share your feedback ðŸ“¢</h3>
    <div id="feedback-prompt">
      <p>Did this page help you?</p>

      <button class="user-feedback-answer user-feedback-answer--yes md-icon">
        <span class="svg-icon">{% include ".icons/material/check.svg" %}</span> Yes
      </button>
      <button class="user-feedback-answer user-feedback-answer--no md-icon">
        <span class="svg-icon">{% include ".icons/material/close.svg" %}</span> No
      </button>

      <div class="user-feedback-response user-feedback-response--yes">
        <p>
          Thanks for the feedback! Is there anything else you'd like to tell us about this page?
        </p>
        <div style="width: 100%; max-width: 550px;">
          <textarea class="user-feedback-textarea user-feedback-textarea--yes" rows="5" maxlength="255"></textarea>
          <br/>
          <button class="user-feedback-send" type="button">Send</button>
          <span class="character-count">255 characters left</span>
          <br/>
        </div>
      </div>

      <div class="user-feedback-response user-feedback-response--no">
        <p>
          We're sorry to hear that. Please let us know what we can improve:
        </p>
        <div style="width: 100%; max-width: 550px;">
          <textarea class="user-feedback-textarea user-feedback-textarea--no" rows="5" maxlength="255"></textarea>
          <br/>
          <span class="character-count">255 characters left</span>
          <button class="user-feedback-send" type="button">Send</button>
          <br/>
        </div>
        <p>
          Alternatively, you can <a target="_blank" href="{{ config.repo_url }}/issues/new?labels=user%20feedback&template=documentation-feedback.md&title=Feedback%20on%20%22{{ page.title }}%22">create a more detailed issue on our GitHub repository</a>.
        </p>
      </div>
    </div>

    <p class="user-feedback-thanks">
      Thanks for helping improve the Codacy documentation.
    </p>

    <p>
      If you have a question or need help, please <a href="{{ config.extra.community_url }}">ask our community</a> or contact <a href="mailto:{{ config.extra.support_email }}?subject=Question%20regarding%20{{ page.title }}">{{ config.extra.support_email }}</a>.
    </p>
  </div>
  <script>
    const feedbackPrompt = document.querySelector('#feedback-prompt')
    const yesButton = document.querySelector('.user-feedback-answer--yes');
    const noButton = document.querySelector('.user-feedback-answer--no');
    const yesResponse = document.querySelector('.user-feedback-response--yes');
    const noResponse = document.querySelector('.user-feedback-response--no');
    const yesQualitativeResponse = document.querySelector('.user-feedback-response--yes textarea');
    const yesSendButton = document.querySelector('.user-feedback-response--yes button');
    const noQualitativeResponse = document.querySelector('.user-feedback-response--no textarea');
    const noSendButton = document.querySelector('.user-feedback-response--no button');
    const userFeedbackThanks = document.querySelector('.user-feedback-thanks');
    const yesRemainingCharacters = document.querySelector('.user-feedback-response--yes .character-count');
    const noRemainingCharacters = document.querySelector('.user-feedback-response--no .character-count');
    const disableFeedbackButtons = () => {
      yesButton.disabled = true;
      noButton.disabled = true;
    };
    const sendQuantitativeFeedback = (value) => {
      if (typeof analytics === "object") {
        // Send an event to Segment
        analytics.track("User Feedback Sent", {
          url: window.location.href,
          value: value
        });
      }
    };
    const sendQualitativeFeedback = (value, text) => {
      feedbackPrompt.classList.add('feedback-prompt--invisible');
      userFeedbackThanks.classList.add('user-feedback-thanks--visible');
      if (typeof analytics === "object") {
        // Send an event to Segment
        analytics.track("User Qualitative Feedback Sent", {
          url: window.location.href,
          value: value,
          text: text
        });
      }
    };
    yesButton.addEventListener('click', () => {
      yesResponse.classList.add('user-feedback-response--visible');
      disableFeedbackButtons();
      sendQuantitativeFeedback(1);
    });
    noButton.addEventListener('click', () => {
      noResponse.classList.add('user-feedback-response--visible');
      disableFeedbackButtons();
      sendQuantitativeFeedback(0);
    });
    yesSendButton.addEventListener('click', () => {
      sendQualitativeFeedback(1, yesQualitativeResponse.value);
    });
    noSendButton.addEventListener('click', () => {
      sendQualitativeFeedback(0, noQualitativeResponse.value);
    });

    yesQualitativeResponse.addEventListener('keyup', () => {
      maximum_length = yesQualitativeResponse.getAttribute('maxlength')
      remaining_length = maximum_length - yesQualitativeResponse.value.length

      if(yesQualitativeResponse.value.length > maximum_length) {
          return false;
      }
      yesRemainingCharacters.innerHTML = remaining_length + " characters left";
    });

    noQualitativeResponse.addEventListener('keyup', () => {
      maximum_length = noQualitativeResponse.getAttribute('maxlength')
      remaining_length = maximum_length - noQualitativeResponse.value.length

      if(noQualitativeResponse.value.length > maximum_length) {
          return false;
      }
      noRemainingCharacters.innerHTML = remaining_length + " characters left";
    });
  </script>
{% endif %}
